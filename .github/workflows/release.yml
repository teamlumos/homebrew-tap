name: Release Homebrew Formula

on:
  repository_dispatch:
    types: [release]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 2.1.3)'
        required: true
        type: string
      prerelease:
        description: 'Is this version a prerelease?'
        required: false
        type: boolean
        default: false

jobs:
  update-homebrew:
    name: Update Homebrew Formula
    runs-on: ubuntu-latest
    steps:
      # Token for accessing lumos-cli releases
      - uses: actions/create-github-app-token@v2
        id: lumos-cli-token
        with:
          app-id: ${{ secrets.GH_BOT_CLIENT_ID }}
          private-key: ${{ secrets.GH_BOT_PRIVATE_KEY }}
          owner: teamlumos
          repositories: lumos-cli

      # Token for committing to homebrew-tap
      - uses: actions/create-github-app-token@v2
        id: app-token
        with:
          app-id: ${{ secrets.GH_BOT_CLIENT_ID }}
          private-key: ${{ secrets.GH_BOT_PRIVATE_KEY }}

      - name: Get bot user ID
        id: bot-user-id
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          echo "user-id=$(gh api "/users/${{ steps.app-token.outputs.app-slug }}[bot]" --jq .id)" >> "$GITHUB_OUTPUT"

      - uses: actions/checkout@v4
        with:
          token: ${{ steps.app-token.outputs.token }}

      - name: Get release info and update formula
        id: update-formula
        env:
          GH_TOKEN: ${{ steps.lumos-cli-token.outputs.token }}
        run: |
          set -euo pipefail

          # Get version from repository_dispatch or workflow_dispatch
          VERSION="${{ github.event.client_payload.version }}"
          if [ -z "$VERSION" ]; then
            VERSION="${{ inputs.version }}"
          fi
          VERSION_NUMBER="${VERSION#v}"

          PRERELEASE="${{ github.event.client_payload.prerelease }}"
          if [ -z "$PRERELEASE" ]; then
            PRERELEASE="${{ inputs.prerelease }}"
          fi

          echo "VERSION=$VERSION" >> "$GITHUB_OUTPUT"
          echo "Using version: $VERSION, prerelease: $PRERELEASE"

          if [ "$PRERELEASE" = "true" ]; then
            FORMULA_FILE="Formula/lumos-prerelease.rb"
          else
            FORMULA_FILE="Formula/lumos.rb"
          fi

          # Get release assets with digests
          echo "Fetching release ${VERSION} from teamlumos/lumos-cli..."
          ASSETS=$(gh release view "${VERSION}" --repo teamlumos/lumos-cli --json assets)

          # Extract digest for each platform (asset names include version)
          MACOS_ARM64_SHA256=$(echo "$ASSETS" | jq -r '.assets[] | select(.name == "lumos-macos-arm64-'"${VERSION}"'.tar.gz") | .digest' | cut -d: -f2)
          LINUX_AMD64_SHA256=$(echo "$ASSETS" | jq -r '.assets[] | select(.name == "lumos-linux-amd64-'"${VERSION}"'.tar.gz") | .digest' | cut -d: -f2)
          LINUX_ARM64_SHA256=$(echo "$ASSETS" | jq -r '.assets[] | select(.name == "lumos-linux-arm64-'"${VERSION}"'.tar.gz") | .digest' | cut -d: -f2)

          # Validate that all SHA256 values are present
          echo "Extracted SHA256 values:"
          echo "  macos-arm64: $MACOS_ARM64_SHA256"
          echo "  linux-amd64: $LINUX_AMD64_SHA256"
          echo "  linux-arm64: $LINUX_ARM64_SHA256"

          if [ -z "$MACOS_ARM64_SHA256" ] || [ -z "$LINUX_AMD64_SHA256" ] || [ -z "$LINUX_ARM64_SHA256" ]; then
            echo "::error::Missing SHA256 for one or more release assets. Ensure the release has all required assets."
            exit 1
          fi

          # Update version
          sed -i "s/version \".*\"/version \"${VERSION_NUMBER}\"/" "$FORMULA_FILE"

          # Update URLs - match any version pattern and update to versioned asset names
          sed -i "s|releases/download/[^/]*/lumos-macos-arm64[^\"]*\.tar\.gz|releases/download/${VERSION}/lumos-macos-arm64-${VERSION}.tar.gz|g" "$FORMULA_FILE"
          sed -i "s|releases/download/[^/]*/lumos-linux-amd64[^\"]*\.tar\.gz|releases/download/${VERSION}/lumos-linux-amd64-${VERSION}.tar.gz|g" "$FORMULA_FILE"
          sed -i "s|releases/download/[^/]*/lumos-linux-arm64[^\"]*\.tar\.gz|releases/download/${VERSION}/lumos-linux-arm64-${VERSION}.tar.gz|g" "$FORMULA_FILE"

          # Update sha256 values - match them to their specific URL context
          sed -i "/lumos-macos-arm64.*\.tar\.gz/!b; n; s/sha256 \".*\"/sha256 \"$MACOS_ARM64_SHA256\"/" "$FORMULA_FILE"
          sed -i "/lumos-linux-amd64.*\.tar\.gz/!b; n; s/sha256 \".*\"/sha256 \"$LINUX_AMD64_SHA256\"/" "$FORMULA_FILE"
          sed -i "/lumos-linux-arm64.*\.tar\.gz/!b; n; s/sha256 \".*\"/sha256 \"$LINUX_ARM64_SHA256\"/" "$FORMULA_FILE"

          # Print the updated formula
          echo "Updated formula:"
          cat "$FORMULA_FILE"

      - name: Commit and push
        env:
          VERSION: ${{ steps.update-formula.outputs.VERSION }}
        run: |
          set -euo pipefail
          git config user.name "${{ steps.app-token.outputs.app-slug }}[bot]"
          git config user.email "${{ steps.bot-user-id.outputs.user-id }}+${{ steps.app-token.outputs.app-slug }}[bot]@users.noreply.github.com"
          git add Formula/
          git commit -m "chore: update lumos to v${VERSION}"
          git push
